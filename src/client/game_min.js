var Troop=function(e,t){this.kind=e;this.health=100;this.attack=t;this.movement_max=1;this.movement=1};var TroopFactory=function(){this.attack={wind:20,water:20,earth:20,fire:20};this.setAttack=function(e,t){this.attack[e]=t};this.makeTroop=function(e,t){if(t>1){var n=[];for(var r=0;r<t;r++){n.push(new Troop(e,this.attack[e]))}return n}else{return new Troop(e,this.attack[e])}}};var Defenders=function(){this.unit_types=["wind","water","fire","earth"];this.remove_index=parseInt(Math.random()*this.unit_types.length);for(var e=0;e<this.unit_types.length;e++){this[this.unit_types[e]]=[]}this.refresh_units=function(){for(var e=0;e<this.unit_types.length;e++){for(var t=0;t<this[this.unit_types[e]].length;t++){this[this.unit_types[e]][t].movement=this[this.unit_types[e]][t].movement_max}}};this.add_unit=function(e){if(e instanceof Troop){this[e.kind].push(e)}else if(Object.prototype.toString.call(e)==="[object Array]"){for(var t=0;t<e.length;t++){this[e[t].kind].push(e[t])}}};this.remove_unit=function(e){this[e.kind].splice(this[e.kind].indexOf(e),1)};this.damage_kind=function(e,t){var n=parseInt(t/this[e].length);for(var r=0;r<this[e].length;r++){this[e][r].health-=n;if(this[e][r].health<=0){this[e].splice(r,1);r--}}};this.deploy_units=function(e){var t=[];while(e>0){for(var n=0;n<this.unit_types.length;n++){var r=(n+this.remove_index+1)%this.unit_types.length;if(this[this.unit_types[r]].length>0){this.remove_index=r;break}}t.push(this[this.unit_types[this.remove_index]].pop());e--}return t};this.get_total=function(){var e=0;for(var t=0;t<this.unit_types.length;t++){e+=this[this.unit_types[t]].length}return e};this.clear_units=function(){for(var e=0;e<this.unit_types.length;e++){this[this.unit_types[e]]=[]}}};var BattleField=function(e,t){var n={wind:"water",water:"fire",fire:"earth",earth:"wind"};this.defender_1=e;this.defender_2=t;this.bane_attack=function(){var e={};var t={};for(var r in n){e[r]=0;t[r]=0;for(var i=0;i<this.defender_1[r].length;i++){e[r]+=this.defender_1[r][i].attack}for(i=0;i<this.defender_2[r].length;i++){t[r]+=this.defender_2[r][i].attack}}for(r in n){this.defender_1.damage_kind(n[r],t[r]);this.defender_2.damage_kind(n[r],e[r])}};this.standard_attack=function(e){var t=this.defender_1.get_total();var n=this.defender_2.get_total();var r=t<n?t:n;var i=this.defender_1.deploy_units(r);var s=this.defender_2.deploy_units(r);while(e>0){for(var o=0;o<r;o++){var u=i[o];var a=s[o];this.troop_fight(u,a);if(u.health<=0&&a.health<=0){i.splice(o,1);s.splice(o,1);o--;r--}else if(u.health<=0){if(this.defender_1.get_total()>0){i.splice(o,1,this.defender_1.deploy_units(1)[0])}else{i.splice(o,1);this.defender_2.add_unit(s.splice(o,1));o--;r--}}else if(a.health<=0){if(this.defender_2.get_total()>0){s.splice(o,1,this.defender_2.deploy_units(1)[0])}else{this.defender_1.add_unit(i.splice(o,1));s.splice(o,1);o--;r--}}}e--}this.defender_1.add_unit(i);this.defender_2.add_unit(s)};this.troop_fight=function(e,t){if(e.attack>t.health||t.attack>e.health){var n=e.health/t.health;var r=t.attack/e.attack;var i;if(n>r){i=t.health/e.attack}else{i=e.health/t.attack}e.health-=Math.ceil(t.attack*i);t.health-=Math.ceil(e.attack*i)}else{e.health-=t.attack;t.health-=e.attack}};this.resolve_conflict=function(){while(this.defender_1.get_total()>0&&this.defender_2.get_total()>0){this.bane_attack();this.standard_attack(3)}}};var Upgrade=function(){this.i=0;this.attack=[20,24,28,32,36,40];this.cost=[0,20,30,40,50,60];this.can_purchase=function(e){if(this.i==this.cost.length)return false;return e>=this.cost[this.i+1]};this.purchase=function(){this.i++;return this.cost[this.i]};this.get_attack=function(){return this.attack[this.i]}};var Player=function(e){this.number=e;this.money=masterConfig.starting_funds;this.prayers=0;this.wind=new Upgrade;this.water=new Upgrade;this.fire=new Upgrade;this.earth=new Upgrade;this.troopFactory=new TroopFactory;this.purchase_upgrade=function(e){this.money-=this[e].purchase();this.troopFactory.setAttack(e,this[e].get_attack())};this.purchase_troop=function(e,t){this.prayers-=10;t.defenders.add_unit(this.troopFactory.makeTroop(e))}};var Territory=function(){this.owner=0;this.state="idle";this.tribute=1;this.treasure=0;this.treasure_awarded=[];this.defenders=new Defenders;this.contenders=new Defenders;this.neighbors={north:null,north_east:null,south_east:null,south:null,south_west:null,north_west:null};this.transfer=function(e,t){var n=this.owner==e.owner?e.defenders:e.contenders;this.defenders.remove_unit(t);n.add_unit(t);t.movement--};this.change_owner=function(e){var t=false;for(var n=0;n<this.treasure_awarded.length;n++){if(this.treasure_awarded[n]==e){t=true}}if(!t){this.treasure_awarded.push(e);e.money+=this.treasure}this.owner=e.number;this.defenders=this.contenders;this.contenders=new Defenders}};var WarZone=function(){this.territories=[];this.census=function(e){var t=0;for(var n=0;n<this.territories.length;n++){if(this.territories[n].owner==e){t+=this.territories[n].defenders.get_total()}}return t};this.collect_tribute=function(e){var t=0;for(var n=0;n<this.territories.length;n++){if(this.territories[n].owner==e){t+=this.territories[n].tribute}}return t};this.refresh_player_troops=function(e){for(var t=0;t<this.territories.length;t++){if(this.territories[t].owner==e){this.territories[t].defenders.refresh_units()}}};this.build=function(){var e=new TroopFactory;var t=5;var n=5;var r=1,i=30+150,s=52+30;var o=82;var u=52;for(var a=0;a<n-1;a++){for(var f=0;f<t;f++){var l=new Territory;l.pos_x=i;l.pos_y=s;i+=o;s+=u;s=Math.round(s*10)/10;u=-u;this.territories.push(l)}i-=o*t;s+=-u;s=Math.round(s*10)/10;u=-u}for(f=0;f<Math.ceil(t/2);f++){var l=new Territory;l.pos_x=i;l.pos_y=s;i+=o*2;this.territories.push(l)}var c;for(var h=0;h<this.territories.length;h++){c=masterConfig.territories["t"+h];if(!!c.north){this.connect_territories(this.territories[h],this.territories[c.north],"north")}if(!!c.north_west){this.connect_territories(this.territories[h],this.territories[c.north_west],"north_west")}if(!!c.north_east){this.connect_territories(this.territories[h],this.territories[c.north_east],"north_east")}if(!!c.wind){this.territories[h].defenders.add_unit(e.makeTroop("wind",c.wind))}if(!!c.water){this.territories[h].defenders.add_unit(e.makeTroop("water",c.water))}if(!!c.fire){this.territories[h].defenders.add_unit(e.makeTroop("fire",c.fire))}if(!!c.earth){this.territories[h].defenders.add_unit(e.makeTroop("earth",c.earth))}if(!!c.player){this.territories[h].owner=c.player}else{this.territories[h].owner=3}if(!!c.treasure){this.territories[h].treasure=c.treasure}this.territories[h].capital=!!c.capital}};this.connect_territories=function(e,t,n){var r={north:"south",north_west:"south_east",north_east:"south_west"};e.neighbors[n]=t;t.neighbors[r[n]]=e};this.mouse_input_update=function(e){var t;var n;var r;var i;var s=9999;var o;for(var u=0;u<this.territories.length;u++){if(this.territories[u].state!="selected"&&this.territories[u].state!="dimmed"){this.territories[u].state="idle";n=e.x-this.territories[u].pos_x;r=e.y-this.territories[u].pos_y;i=n*n+r*r;i=Math.sqrt(i);if(i<s){s=i;o=u}}}if(s<=60){this.territories[o].state="hover"}}};var GameMaster=function(){this.game_state="unstarted";this.active_player=null;this.opponent_player=null,this.warZone=new WarZone;this.set_active_player=function(e){this.active_player=new Player(e);if(e==1){this.opponent_player=new Player(2)}else{this.opponent_player=new Player(1)}};this.player_start_turn=function(e){e.prayers+=masterConfig.prayers_per_turn-warZone.census(e.number);e.money+=warZone.collect_tribute(e.number);warZone.refresh_player_troops(e.number);this.game_state="make_purchases"};this.player_end_turn=function(e){this.game_state="turn_ended";if(e==this.opponent_player){this.player_start_turn(this.active_player)}}};var UI=function(){this.set_warZone=function(e){this.warZone=e};this.select_territory=function(e){var t=this.warZone.territories[e];for(var n=0;n<t.defenders.wind.length;n++){}for(var n=0;n<t.defenders.water.length;n++){}for(var n=0;n<t.defenders.fire.length;n++){}for(var n=0;n<t.defenders.earth.length;n++){}}};var Graphics=function(){this.canvas=document.querySelector("#warzone_canvas");this.context=this.canvas.getContext("2d");this.draw_lists={bg:[]};this.updated=false;this.draw_circle=function(e,t){var n=this.context;n.beginPath();n.arc(e,t,10,0,2*Math.PI,false);n.fillStyle="red";n.fill();n.stroke()};this.t=function(){var e=this;this.draw=function(){e.context.clearRect(0,0,e.canvas.width,e.canvas.height);if(e.territories!=null){e.draw_territories(e.territories)}return true}};this.t();this.assign_territories=function(e){this.territories=e};this.draw_territories=function(e){var t={p1:[230,30,30],p2:[30,30,230],p3:[150,150,150],idle:[0,0,0],hover:[15,15,15],selected:[40,40,40],dimmed:[-120,-120,-120]};var n=this.context;for(var r=0;r<e.length;r++){var i=e[r].pos_x,s=e[r].pos_y,o=t["p"+e[r].owner].slice(0);for(var u=0;u<3;u++){o[u]+=t[e[r].state][u]}n.strokeStyle="#000000";n.lineWidth=3;n.beginPath();n.moveTo(i-30,s-52);n.lineTo(i+30,s-52);n.lineTo(i+52,s);n.lineTo(i+30,s+52);n.lineTo(i-30,s+52);n.lineTo(i-52,s);n.lineTo(i-30,s-52);n.fillStyle="rgb("+o.toString()+")";n.fill();n.stroke();n.closePath();n.beginPath();n.arc(i,s,10,0,2*Math.PI,false);n.fillStyle="green";n.fill();n.stroke()}return true};this.initiate=function(){if(window.webkitRequestAnimationFrame){window.each_frame=function(e){var t=function(){e();requestAnimationFrame(t)};t()}}else if(window.mozRequestAnimationFrame){window.each_frame=function(e){var t=function(){e();mozRequestAnimationFrame(t)};t()}}else{window.each_frame=function(e){setInterval(e,1e3/30)}}window.each_frame(this.draw)}};var MouseInput=function(){this.canvas=document.querySelector("#warzone_canvas");this.x=0;this.y=0;this.observers=[];this.add_observer=function(e){var t=false;for(var n=0;n<this.observers.length;n++){if(this.observers[n]==e){t=true;break}}if(!t){this.observers.push(e)}};this.remove_observer=function(e){for(var t=0;t<this.observers.length;t++){if(this.observers[t]==e){this.observers.splice(t,1);break}}};this.initiate=function(){var e=this;this.canvas.addEventListener("mousemove",function(t){e.x=t.x;e.y=t.y;for(var n=0;n<e.observers.length;n++){e.observers[n].mouse_input_update(e)}})}};var masterConfig={prayers_per_turn:100,starting_funds:20,territories:{t0:{north:5,north_east:1,fire:7,treasure:5},t1:{north_east:7,wind:2},t2:{north_west:1,north_east:3,wind:1,water:1,fire:1,earth:1},t3:{north_west:7,north:8,wind:2},t4:{north_west:3,north:9,earth:3},t5:{north:10,north_east:6,wind:1,water:1,fire:1,earth:1,player:1},t6:{north_west:10,north:11,wind:5,water:5,fire:5,earth:5,player:1,capital:true},t7:{north_west:6,north:12,earth:1},t8:{north_west:12,north:13,north_east:14,fire:1},t9:{water:12,treasure:10},t10:{north_east:11,wind:2,water:2,fire:2,earth:2,player:1},t11:{north:16,wind:1},t12:{north_west:11,north:17,wind:4,water:4,fire:4,earth:4,treasure:15},t13:{north_west:17,north_east:19,wind:5,water:5,fire:5,earth:5,player:2,capital:true},t14:{north_west:13,north:19,wind:2,water:2,fire:2,earth:2,player:2},t15:{north:20,earth:16,treasure:10},t16:{north_west:20,north_east:21,fire:2},t17:{north_west:16,north_east:18,water:1},t18:{north_west:21,north_east:22,fire:2},t19:{north:22,wind:1,water:1,fire:1,earth:1,player:2},t20:{water:3},t21:{wind:1,water:1,fire:1,earth:1},t22:{wind:7,treasure:5}}};var graphics=new Graphics;var gm=new GameMaster;gm.warZone.build();graphics.assign_territories(gm.warZone.territories);graphics.initiate();var mouseInput=new MouseInput;mouseInput.initiate();mouseInput.add_observer(gm.warZone)